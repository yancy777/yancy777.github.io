; (function ($) { $.mola = $.extend({ appointment: function (options) { var defualt = { template: 'templateappointment', trigger: 'apponit', event: 'click', ok: '#J_shop_comfire', cancel: '#J_shop_cancel', shopSelect: '#J_shop_selected', shopList: '#J_shop_list' }; defualt = $.extend(defualt, options || {}); var T; var $tpl = $('[mola=' + defualt.template + ']').html(), $trigger = $('[mola=' + defualt.trigger + ']'), DATA = { colorsize: '', mobile: '', shop: '' }, is_show_appoint = $('#hdAppointTryCloth').val(), $body = $('body'), $auto_dialog = $("#dialogmessage"), $shop_list_tpl = $('[mola="templatestorelist"]').html(); var url = { getShopInfo: '/item/GetO2OShopInfo', setAppointment: '/item/RecordWareSubcribe' }; if ($trigger.length <= 0) { return } function init() { if (!(is_show_appoint == 0 || is_show_appoint == '' || is_show_appoint == 'undefined')) { event(); $trigger.show() } } function event() { $trigger.bind(defualt.event, function () { $.post('item/islogin', function (login_data) { if (login_data.Code == 2) { $.mola.ifrmlogin({ loginback: function () { $trigger.trigger(defualt.event) }, registerback: function () { $trigger.trigger(defualt.event) }, hostidx: 0 }) } else { DATA.mobile = isNull(login_data.Data); getShopInfo() } }) }); $body.delegate(defualt.cancel, 'click', function () { closeAppointDialog() }); $body.delegate(defualt.ok, 'click', function () { var appoint_data = { StyleCode: $('#J_hd_warecode').val().split(',')[0].split('-')[0], WareCode: $('#J_hd_warecode').val().split(',')[0], BeginDate: changeDateFormat(DATA.BeginDate), EndDate: $('#J_date_end').val(), mobileCode: $('#J_mobile').val(), O2OShopCode: $('#J_appoint_dialog').find('.J_shop_selected').attr('data-shopcode') }; var warn = $('#J_appoint_warn'); if (!isMobile(appoint_data.mobileCode)) { warn.html('* 请输入正确的手机号码！').show(); return } if (appoint_data.WareCode == '') { warn.html('* 请选择尺码！').show(); return } $.post(url.setAppointment, appoint_data, function (data) { if (data.Result.Data) { closeAppointDialog(); autoDialog(data.Result.Message); warn.hide() } else { warn.html('* ' + data.Result.Message).show() } }, 'json') }); $body.delegate('.J_color', 'click', function () { var _this = $(this); var _size = $('#J_appoint_dialog').find('.size').find('.J_size'); _this.addClass('seldon').siblings().removeClass('seldon'); var color = _this.attr('color'); _size.filter(':not([color=' + color + '])').hide().end().filter('[color=' + color + ']').show().eq(0).addClass('selon').siblings().removeClass('selon'); if (_ctip[0]) { _ctip.text(_this.attr('title')) } $('#J_hd_warecode').val('') }); $body.delegate('.J_size', 'click', function () { var _this = $(this); var content = _this.attr('warecode'); var warecode = content.split(','); var stylecode = warecode[0].split('-')[0]; _this.addClass('selon').siblings().removeClass('selon'); $('#J_hd_warecode').val(content) }); $body.delegate('.J_shop_selected', 'click', function (event) { var $ul = $(this).next('ul'); var $icon = $(this).find('.trigle-icon'); if ($ul.is(':visible')) { $ul.slideUp('fast'); $icon.addClass('trigle-up').removeClass('trigle-down') } else { $ul.slideDown('fast'); $icon.removeClass('trigle-up').addClass('trigle-down') } return false }); $body.bind('click', function () { var $shop_list = $('.J_shop_list'); if ($shop_list.length > 0 && $shop_list.is(':visible')) { $shop_list.slideUp('fast') } }); $body.delegate('.J_shop_information', 'click', function () { var $ul = $(this).parent(); var $content = $('.J_shop_selected'); var $shop = $content.find('.J_shop_name'); var $shop_code = $(this).attr('data-code'); var $shop_name = $(this).attr('data-name'); $ul.slideUp('fast'); $content.attr('data-shopcode', $shop_code); $shop.html($shop_name) }) } function getShopInfo() { $.post(url.getShopInfo, function (d) { if (d == null || d == "") { return } if (d.length == 0) { return } if (d.length > 0) { d['ShopFristName'] = d[0]['ShopName']; d['ShopFristCode'] = d[0]['ShopCode'] } d.IsGetInShop = 0; DATA.ShopFristCode = d.O2OShopInfo[0].ShopCode; DATA.ShopFristName = d.O2OShopInfo[0].ShopName; DATA.colorsize = getColorSize(); DATA.BeginDate = changeDateFormat(d.BeginDate); DATA.lastDayDate = changeDateFormat(addDay(DATA.BeginDate, 7)); DATA.shop = template($shop_list_tpl, d); html = template($tpl, DATA); appointDialog(html) }, 'json') } function changeDateFormat(time) { return time.match(/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/) == null ? time : time.replace(/-/g, '/') } function template(tpl, d) { return easyTemplate(tpl, d).toString() } function getColorSize() { var colorsize = eval('(' + $('#hdColorSize').val() + ')'); return colorsize.length > 0 ? colorsize[0] : {} } function addDay(currdate, daynum) { var d = new Date(currdate); if (d == "Invalid Date") { return } var n = d.getTime() + daynum * 24 * 60 * 60 * 1000; var result = new Date(n); return (result.getFullYear() + "-" + (result.getMonth() + 1) + "-" + result.getDate()) } function appointDialog(html) { var $appoint_dialog = $('#J_appoint_dialog'); if ($appoint_dialog.length <= 0) { $('<div id="J_appoint_dialog">' + html + '</div>').dialog({ title: "请录入试穿信息", width: 580, modal: true }) } else { $appoint_dialog.dialog('open') } } function closeAppointDialog() { var $appoint_dialog = $('#J_appoint_dialog'); $appoint_dialog.dialog('close') } function isMobile(val) { return /^1[0-9][0-9]{9,9}$/i.test(val) } function isNull(val) { return val == null || val == "" ? "" : val } function autoDialog(html) { $auto_dialog.html(html); $auto_dialog.dialog({ width: 400, height: 100, title: '消息提示' }); T = setInterval(function () { if ($auto_dialog != null) { $auto_dialog.dialog('close'); clearInterval(T) } }, 3000) } init() } }, $.mola || {}) })(jQuery); $(function () { $.mola.appointment() });
(function (A) { var B = '<img src="http://i2.mbscss.com/img/shopping/20120619/loading.gif" width="32" height="32"/>'; A.mola = A.extend({ getInShop: function () { var H = "/item/GetShopListByWareCode"; var F = { warecode: "" }; var N = {}; var G = A('[mola="templatestorelist"]').html(); var E = A('[mola="getInShopContent"]'); var C = A('[mola="getInShop"]'); if (C.length == 0) { return } function K() { J(); I(L) } function D() { if (C.length == 0) { return } C.bind("mouseenter mouseleave", function (R) { var S = ""; var Q = E.find(".J_shop_list"); var P = A(this).find(".J_gis_content"); if (R.type == "mouseenter") { P.show(); Q.removeClass("fn-none"); J(); S = F.warecode; if (N.hasOwnProperty(S)) { M(N[S]) } else { I(O) } } else { if (R.type == "mouseleave") { P.hide(); Q.addClass("fn-none") } } }) } function J() { var P = ""; A('[mola="color"]', ".licolork").each(function (R, S) { var Q = A(S); if (Q.hasClass("seldon")) { P = Q.attr("color"); return } }); A('[mola="size"]').each(function (R, S) { var Q = A(S); if (Q.hasClass("selon") && Q.attr("color") == P) { F.warecode = Q.attr("warecode").split(",")[0]; return } }) } function I(P) { E.html(B); A.post(H, F, function (Q) { var R = A.parseJSON(Q); if (P && typeof P === "function") { P(R) } }) } function O(P) { if (P.IsSuccess) { var Q = ""; P.O2OShopInfo = P.Data; P.IsGetInShop = 1; Q = easyTemplate(G, P).toString(); N[F.warecode] = Q; M(Q) } else { M("亲~该款旗下门店没有存库哈~") } } function L(P) { if (P.IsSuccess && !(P.Data == "" || P.Data == null)) { var Q = ""; P.O2OShopInfo = P.Data; Q = easyTemplate(G, P).toString(); N[F.warecode] = Q; M(Q); C.show(); D() } else { C.hide() } } function M(P) { E.html(P) } K() } }, A.mola || {}) })(jQuery); $(function () { $.mola.getInShop() });
